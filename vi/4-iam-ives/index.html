<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.121.1">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>IAM Investigation :: AWS System Manager</title>

    
    <link href="../../css/nucleus.css?1705747926" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1705747926" rel="stylesheet">
    <link href="../../css/hybrid.css?1705747926" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1705747926" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1705747926" rel="stylesheet">
    <link href="../../css/auto-complete.css?1705747926" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css?1705747926" rel="stylesheet">
    <link href="../../css/theme.css?1705747926" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1705747926" rel="stylesheet">
    
    <link href="../../css/theme-workshop.css?1705747926" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1705747926"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="../../vi/4-iam-ives/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="../../">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1705747926"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1705747926"></script>
<script type="text/javascript">
    
        var baseurl = "\/vi";
    
</script>
<script type="text/javascript" src="../../js/search.js?1705747926"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-introduce/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="../../vi/1-introduce/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-setup/" title="Cài Đặt" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/">
           <b> 2. </b> Cài Đặt
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.1-set-event-engine-/" title="Thiết lập Non-event engine - Bước 1" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.1-set-event-engine-/">
           <b> 2.1. </b> Thiết lập Non-event engine - Bước 1
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.2-step-2/" title="Thiết lập Non-event engine - Bước 2 CT Lake" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.2-step-2/">
           <b> 2.2. </b> Thiết lập Non-event engine - Bước 2 CT Lake
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.3-step-3/" title="Thiết lập Non-event engine - Bước 3  SageMaker và mô phỏng" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.3-step-3/">
           <b> 2.3. </b> Thiết lập Non-event engine - Bước 3  SageMaker và mô phỏng
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-federation/" title="Giới thiệu dịch vụ" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/">
           <b> 3. </b> Giới thiệu dịch vụ
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/3-federation/3.1-tpch/" title="Làm quen với AWS CloudTrail và CloudTrail Lake" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/3.1-tpch/">
           <b> 3.1. </b> Làm quen với AWS CloudTrail và CloudTrail Lake
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/3-federation/3.2-setting-note/" title="Thiết lập Sagemaker Notebooks" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/3.2-setting-note/">
           <b> 3.2. </b> Thiết lập Sagemaker Notebooks
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-iam-ives/" title="IAM Investigation" class="dd-item 
        
        active
        
        ">
      <a href="../../vi/4-iam-ives/">
           <b> 4. </b> IAM Investigation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-ec2-inves/" title="EC2 Investigation" class="dd-item 
        
        
        
        ">
      <a href="../../vi/5-ec2-inves/">
          <b>5. </b>EC2 Investigation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/6-incident-runbook/" title="Sổ tay quản lý rủi ro" class="dd-item 
        
        
        
        ">
      <a href="../../vi/6-incident-runbook/">
          <b>6. </b>Sổ tay quản lý rủi ro
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/7-teardown/" title="Dọn dẹp tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="../../vi/7-teardown/">
          <b>7. </b>Dọn dẹp tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="/4-iam-ives/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="/vi/4-iam-ives/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>20-01-2024</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/uyennhiphantu/"  style="color:orange">Uyên Nhi  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='../../vi/'>Xây dựng sổ tay phản ứng sự cố AWS bằng Jupyter notebooks và CloudTrail Lake</a> > IAM Investigation
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#giới-thiệu">Giới thiệu</a></li>
        <li><a href="#event-data-store-id-trong-queries">Event data store ID trong queries</a></li>
        <li><a href="#bước-1---thiết-lập-cloudtrail-lake">Bước 1 - Thiết lập CloudTrail Lake</a></li>
        <li><a href="#bước-2---investigation">Bước 2 - Investigation</a></li>
        <li><a href="#21-investigating-lỗi-ủy-quyền">2.1 Investigating Lỗi Ủy quyền</a></li>
        <li><a href="#26-tổng-hợp-tất-cả">2.6 Tổng hợp Tất cả</a></li>
        <li><a href="#bước-3---chính-sách-ngăn-chặn">Bước 3 - Chính sách ngăn chặn</a></li>
        <li><a href="#bước-32-vô-hiệu-hóa-khóa-truy-cập">Bước 3.2 Vô hiệu hóa Khóa Truy Cập</a></li>
        <li><a href="#bước-3---gắn-chính-sách-từ-chối-tất-cả">Bước 3 - Gắn Chính Sách Từ Chối Tất Cả</a></li>
        <li><a href="#bước-4---tải-xuống-notebook">Bước 4 - Tải xuống Notebook</a></li>
        <li><a href="#bước-5---kết-luận">Bước 5 - Kết luận</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              IAM Investigation
            </h1>
          

        



	
<div class="notices note" ><p>Nếu bạn không sử dụng Event Engine, vui lòng đảm bảo tất cả các mẫu CloudFormation đã triển khai thành công và bạn đã đợi ít nhất 15 phút để tạo nhật ký CloudTrail</p>
</div>

<h3 id="giới-thiệu">Giới thiệu</h3>
<p>Trong cuộc điều tra đầu tiên, bạn đã biết được về một sự kiện bảo mật tiềm ẩn trong tài khoản AWS của bạn, một số hành vi đáng ngờ đã được đội phát triển phát hiện khi họ thấy một đợt tăng đột ngột trong số lần đăng nhập không thành công trên một trong các bảng điều khiển của họ vào sáng nay. Tại thời điểm này, họ không thể cung cấp thêm chi tiết nào khác cho bạn, vì vậy bạn sẽ cần tiến hành cuộc điều tra của riêng mình!</p>
<h3 id="event-data-store-id-trong-queries">Event data store ID trong queries</h3>
<p>Bạn sẽ chạy và xây dựng các truy vấn để điều tra sự cố IAM và sự cố EC2. <strong>Hãy đảm bảo bạn thay thế</strong> <code>EDS_ID</code> <strong>sự thật tế của bạn ở CloudTrail Lake Event data store ID</strong>.</p>
<h3 id="bước-1---thiết-lập-cloudtrail-lake">Bước 1 - Thiết lập CloudTrail Lake</h3>
<p>Bạn sẽ bắt đầu bằng cách chạy ba khối mã đầu tiên của notebook. Nhấn vào 3 khối mã đầu tiên như hình dưới đây rồi click vào <strong>Run</strong>
<img src="18.png" alt="Alt text">
<img src="19.png" alt="Alt text">
<img src="20.png" alt="Alt text"></p>
<h3 id="bước-2---investigation">Bước 2 - Investigation</h3>
<h3 id="21-investigating-lỗi-ủy-quyền">2.1 Investigating Lỗi Ủy quyền</h3>
<p><strong>2.1.1 Xây dựng Truy vấn</strong></p>
<p>Như bạn đã biết có một số lần đăng nhập không thành công nhưng không có thông tin nào khác, bạn sẽ cần thực hiện một số hoạt động khám phá trước hết.</p>
<p>Trước tiên, bạn nên khám phá bất kỳ cố gắng truy cập không thành công nào chúng ta có trong AWS CloudTrail logs của bạn bằng cách sử dụng truy vấn SQL mẫu được bao gồm ở đây. Bạn cũng có thể tìm thấy truy vấn này trong Jupyter notebook của bạn ở phần 2.1.</p>
<p>Trong truy vấn này, bạn sẽ truy vấn tất cả các trường, tìm kiếm các mã lỗi cụ thể như AccessDenied và lọc bất kỳ điều gì là thực thể IAM của AWS bằng cách tìm kiếm <code>useridentity.arn như '%iam%'</code>. Các mục sau đó sẽ được sắp xếp theo <code>eventTime</code>. Hãy đảm bảo bạn dán <code>ID EDS</code> thực tế của mình vào nơi giữ chỗ <code>EDS_ID</code>, sau đó chạy code.</p>
<p><strong>2.1.2 Thực hiện Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn đã dán <strong>EDS_ID</strong> ở mục 1.1 của mình vào truy vấn.
<img src="21-1.png" alt="Alt text"></li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong>
<img src="22.png" alt="Alt text"></li>
</ol>
<p><strong>2.1.3 Phân tích Kết quả</strong></p>
<p><strong>Các sự cố xác thực nào đã xảy ra?</strong></p>
<p><strong>2.2 Điều tra về User Identities có Authorization Failures</strong>
<strong>2.2.1 Xây dựng Truy vấn</strong>
Giống như trước đó, có rất nhiều dữ liệu ở đây để bạn cố gắng hiểu rõ. Bạn có thể thấy có một số lỗi <code>AccessDenied</code> và <code>Client.UnauthorizedOperation</code> nhưng bạn cần phát triển truy vấn thêm.</p>
<p>Điều hữu ích ở đây là lấy số lượng của các thực thể AWS IAM đang tạo ra tất cả các yêu cầu này và sau đó nhóm chúng lại. Việc sử dụng câu lệnh <code>count</code> và <code>groupby</code> trong truy vấn của bạn sẽ là một điểm bắt đầu tốt. Bạn có thể tạo một ô mới trong Jupyter notebook hoặc ghi đè ô hiện tại.</p>
<p>Xem gợi ý ở đây!</p>
<pre tabindex="0"><code>select userIdentity.arn, count(*) as total
    from EDS_ID
    where errorCode in (&#39;Client.UnauthorizedOperation&#39;,&#39;Client.InvalidPermission.NotFound&#39;,&#39;Client.OperationNotPermitted&#39;,&#39;AccessDenied&#39;)
    and useridentity.arn like &#39;%iam%&#39;
    group by userIdentity.arn
    order by total desc
</code></pre><p><strong>2.2.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <code>EDS_ID</code> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong></li>
</ol>
<p><strong>2.2.3 Phân tích Kết quả</strong>
ARN(s) của thực thể AWS IAM gây ra hành vi đáng ngờ là gì?</p>
<p>Lưu ý: ARNs cho AWS IAM có định dạng <code>'arn:aws:iam::account-id:resource-type/resource-name'</code></p>
<p>Bây giờ bạn có thể xem xét thực thể AWS IAM nào tạo ra phần lớn các cuộc gọi trái phép, cũng có một số khác trong đó chỉ tạo ra một vài cuộc gọi nhưng tập trung của bạn nên là vào các cuộc gọi được sử dụng nhiều lần nhất.</p>
<p><strong>2.3 Điều tra về Suspicious Identity</strong>
<strong>2.3.1 Xây dựng Truy vấn</strong>
Bây giờ bạn đã xác định được thực thể AWS IAM có thể đã bị xâm phạm, bạn nên tiến hành các cuộc điều tra tiếp theo để xác định thực thể đã cố gắng làm gì.</p>
<p>Bạn có thể bắt đầu bằng một truy vấn đơn giản sử dụng ARN bạn đã xác định trong bước trước để hạn chế tìm kiếm.
Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select *
from EDS_ID
where userIdentity.arn=&#39;arn:aws:iam::account-id:resource-type/resource-name&#39;
</code></pre><p><strong>2.3.2 Chạy Truy vấn</strong>
1.Đảm bảo bạn dán <code>EDS_ID</code> của mình vào truy vấn.
2.Chạy ô truy vấn.
3. Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong></p>
<p><strong>2.3.3 Phân tích Kết quả</strong>
Những hành động nào mà người dùng có vẻ đã bị thâm nhập có thể thực hiện được?</p>
<p><strong>2.4 Điều tra về Các Dịch vụ AWS được Sử Dụng bởi Suspicious Identity</strong>
<strong>2.4.1 Xây dựng Truy vấn</strong>
Một lĩnh vực khác để điều tra là count và group lại các điểm cuối dịch vụ AWS mà các cuộc gọi đang được thực hiện đến, để bạn có thể xem xét những dịch vụ nào đang được liệt kê bởi thực thể IAM.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select eventSource, count(*) as total
    from EDS_ID
    where userIdentity.arn=&#39;arn:aws:iam::account-id:resource-type/resource-name&#39;
    group by eventSource
    order by total desc
</code></pre><p><strong>2.4.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>userIdentity.arn</strong> vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong></li>
</ol>
<p><strong>2.4.3 Phân tích Kết quả</strong>
Những dịch vụ AWS nào đang là mục tiêu bởi Suspicious Identity?</p>
<p><strong>2.5 Điều tra về Hành động được thực hiện bởi Suspicious Identity</strong>
<strong>2.5.1 Xây dựng Truy vấn</strong>
Bây giờ bạn biết các điểm cuối dịch vụ AWS, một cuộc điều tra hữu ích khác là xem xét những cuộc gọi nào đang được thực hiện đến những điểm cuối đó, để có thêm thông tin về những gì thực thể IAM đang cố gắng thực hiện.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select eventName, count(*) as total
    from EDS_ID
    where userIdentity.arn=&#39;arn:aws:iam::account-id:resource-type/resource-name&#39;
    group by eventName
    order by total desc
</code></pre><p><strong>2.5.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>userIdentity.arn</strong> vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong></li>
</ol>
<p><strong>2.5.3 Phân tích Kết quả</strong>
Những hành động AWS nào đang là mục tiêu bởi suspicious identity?</p>
<h3 id="26-tổng-hợp-tất-cả">2.6 Tổng hợp Tất cả</h3>
<p><strong>2.6.1 Xây dựng Truy vấn</strong>
Tổng hợp các truy vấn trước đó để tạo một truy vấn duy nhất hiển thị tên sự kiện, dịch vụ AWS và khu vực AWS nơi các yêu cầu đang được thực hiện bởi thực thể AWS IAM bị xâm nhập.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select eventName, count(*) as total, eventSource, awsRegion
    from EDS_ID
    where userIdentity.arn=&#39;arn:aws:iam::account-id:resource-type/resource-name&#39;
    group by eventName, eventSource, awsRegion
    order by total desc
</code></pre><p><strong>2.6.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>userIdentity.arn</strong> vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn tất.</strong></li>
</ol>
<p><strong>2.6.3 Phân tích Kết quả</strong>
Hành động, mục tiêu và khu vực AWS nào đang là mục tiêu bởi hành vi đáng ngờ?</p>
<h3 id="bước-3---chính-sách-ngăn-chặn">Bước 3 - Chính sách ngăn chặn</h3>
<p>Để ngăn chặn việc sử dụng thực thể AWS IAM, bạn nên tắt tài khoản người dùng AWS IAM đã bị xâm nhập để ngăn chặn cuộc tấn công. Đầu tiên, bạn sẽ muốn kiểm tra xem các khóa không được sử dụng cho các quy trình sản xuất. Chúng ta biết rằng tài khoản người dùng AWS IAM không tạo bất kỳ vai trò hoặc thực thể AWS IAM bổ sung nào nên bạn chỉ cần tắt một tài khoản.</p>
<p><strong>Bước 3.1 Xác định ID Khóa Truy Cập</strong>
Tiếp theo, bạn cần xác định useridentity.accesskeyid(s) để biết khóa truy cập nào bạn muốn tắt.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select useridentity.accesskeyid, count(*) as total
    from EDS_ID
    where userIdentity.arn=&#39;arn:aws:iam::account-id:resource-type/resource-name&#39;
    group by useridentity.accesskeyid
    order by total desc
</code></pre><p><strong>Những ID khóa truy cập mà bạn cần tắt là gì?</strong></p>
<h3 id="bước-32-vô-hiệu-hóa-khóa-truy-cập">Bước 3.2 Vô hiệu hóa Khóa Truy Cập</h3>
<p>Bây giờ bạn đã có ID khóa truy cập, thay thế chuỗi <code>'KEYID'</code> và <code>'USERNAME'</code>bằng các giá trị đó. Mã này sử dụng SDK Python boto3 và sẽ vô hiệu hóa ID khóa truy cập đó cho người dùng cụ thể.</p>
<pre tabindex="0"><code>access_key_to_deactivate=&#39;KEYID&#39;
username=&#39;USERNAME&#39;
iam = boto3.resource(&#39;iam&#39;, region_name=region)
access_key = iam.AccessKey(username,access_key_to_deactivate)
response_status = access_key.deactivate()
status_code = response_status[&#39;ResponseMetadata&#39;][&#39;HTTPStatusCode&#39;]
if status_code == 200:
    print(&#34;Key Disabled Successfully&#34;)
else:
    print(&#34;Key deactivation failed&#34;)
</code></pre><h3 id="bước-3---gắn-chính-sách-từ-chối-tất-cả">Bước 3 - Gắn Chính Sách Từ Chối Tất Cả</h3>
<p>Cuối cùng, bạn nên áp dụng một chính sách nội tuyến cho tài khoản người dùng AWS IAM sẽ từ chối tất cả các hành động một cách rõ ràng để ngăn chặn việc sử dụng tài khoản đó. Trong mã sau, thay thế <code>'USERNAME'</code> bằng tên người dùng của tài khoản để áp dụng chính sách.</p>
<pre tabindex="0"><code>username=&#39;USERNAME&#39;

iam = boto3.client(&#39;iam&#39;, region_name=region)
response = iam.put_user_policy(UserName=username,PolicyName=&#39;Block&#39;,PolicyDocument=&#39;{&#34;Version&#34;:&#34;2012-10-17&#34;,&#34;Statement&#34;:{&#34;Effect&#34;:&#34;Deny&#34;,&#34;Action&#34;:&#34;*&#34;,&#34;Resource&#34;:&#34;*&#34;}}&#39;)
status_code = response[&#39;ResponseMetadata&#39;][&#39;HTTPStatusCode&#39;]
if status_code == 200:
    print(&#34;Policy attached successfully&#34;)
else:
    print(&#34;Policy attachment failed&#34;)
</code></pre><h3 id="bước-4---tải-xuống-notebook">Bước 4 - Tải xuống Notebook</h3>
<ol>
<li>Chọn <strong>File</strong>, sau đó chọn <strong>Download as</strong>, tiếp đó chọn <strong>Notebook (.ipynb)</strong>. Điều này phục vụ để làm bằng chứng cho cuộc điều tra của bạn.
<img src="23.png" alt="Alt text"></li>
</ol>
<h3 id="bước-5---kết-luận">Bước 5 - Kết luận</h3>
<p>Bạn đã thành công trong việc:</p>
<ol>
<li>Thực hiện các hoạt động phát hiện và điều tra về các cố gắng đăng nhập không thành công được báo cáo.</li>
<li>Xác định tài khoản người dùng AWS IAM bị xâm nhập và tìm ra các hành động mà nó đã cố gắng thực hiện.</li>
<li>Vô hiệu hóa các khóa truy cập được sử dụng bởi tài khoản người dùng AWS IAM bị xâm nhập và áp dụng một chính sách từ chối tất cả một cách rõ ràng.</li>
</ol>
<p><strong>Những bước nào có thể đã được thực hiện để ngăn chặn việc sử dụng các khóa truy cập?</strong></p>
<p>Xem câu trả lời dưới đây!
Tập trung quản lý danh tính bằng cách sử dụng SSO hoặc federation</p>
<p>Giả định vai trò bằng cách sử dụng Amazon STS để có thông tin đăng nhập tạm thời</p>
<p>Triển khai MFA cho việc đăng nhập</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../vi/3-federation/3.2-setting-note/" title="Thiết lập Sagemaker Notebooks"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../vi/5-ec2-inves/" title="EC2 Investigation" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1705747926"></script>
    <script src="../../js/perfect-scrollbar.min.js?1705747926"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1705747926"></script>
    <script src="../../js/jquery.sticky.js?1705747926"></script>
    <script src="../../js/featherlight.min.js?1705747926"></script>
    <script src="../../js/highlight.pack.js?1705747926"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js?1705747926"></script>
    <script src="../../js/learn.js?1705747926"></script>
    <script src="../../js/hugo-learn.js?1705747926"></script>

    <link href="../../mermaid/mermaid.css?1705747926" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js?1705747926"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
