<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.121.1">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>EC2 Investigation :: AWS System Manager</title>

    
    <link href="../../css/nucleus.css?1705746998" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1705746998" rel="stylesheet">
    <link href="../../css/hybrid.css?1705746998" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1705746998" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1705746998" rel="stylesheet">
    <link href="../../css/auto-complete.css?1705746998" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css?1705746998" rel="stylesheet">
    <link href="../../css/theme.css?1705746998" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1705746998" rel="stylesheet">
    
    <link href="../../css/theme-workshop.css?1705746998" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1705746998"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="../../vi/5-ec2-inves/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="../../">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1705746998"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1705746998"></script>
<script type="text/javascript">
    
        var baseurl = "\/vi";
    
</script>
<script type="text/javascript" src="../../js/search.js?1705746998"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-introduce/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="../../vi/1-introduce/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-setup/" title="Cài Đặt" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/">
           <b> 2. </b> Cài Đặt
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.1-set-event-engine-/" title="Thiết lập Non-event engine - Bước 1" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.1-set-event-engine-/">
           <b> 2.1. </b> Thiết lập Non-event engine - Bước 1
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.2-step-2/" title="Thiết lập Non-event engine - Bước 2 CT Lake" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.2-step-2/">
           <b> 2.2. </b> Thiết lập Non-event engine - Bước 2 CT Lake
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-setup/2.3-step-3/" title="Thiết lập Non-event engine - Bước 3  SageMaker và mô phỏng" class="dd-item 
        
        
        
        ">
      <a href="../../vi/2-setup/2.3-step-3/">
           <b> 2.3. </b> Thiết lập Non-event engine - Bước 3  SageMaker và mô phỏng
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-federation/" title="Giới thiệu dịch vụ" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/">
           <b> 3. </b> Giới thiệu dịch vụ
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/3-federation/3.1-tpch/" title="Làm quen với AWS CloudTrail và CloudTrail Lake" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/3.1-tpch/">
           <b> 3.1. </b> Làm quen với AWS CloudTrail và CloudTrail Lake
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/3-federation/3.2-setting-note/" title="Thiết lập Sagemaker Notebooks" class="dd-item 
        
        
        
        ">
      <a href="../../vi/3-federation/3.2-setting-note/">
           <b> 3.2. </b> Thiết lập Sagemaker Notebooks
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-iam-ives/" title="IAM Investigation" class="dd-item 
        
        
        
        ">
      <a href="../../vi/4-iam-ives/">
           <b> 4. </b> IAM Investigation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-ec2-inves/" title="EC2 Investigation" class="dd-item 
        
        active
        
        ">
      <a href="../../vi/5-ec2-inves/">
          <b>5. </b>EC2 Investigation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/6-incident-runbook/" title="Sổ tay quản lý rủi ro" class="dd-item 
        
        
        
        ">
      <a href="../../vi/6-incident-runbook/">
          <b>6. </b>Sổ tay quản lý rủi ro
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/7-teardown/" title="Dọn dẹp tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="../../vi/7-teardown/">
          <b>7. </b>Dọn dẹp tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="/5-ec2-inves/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="/vi/5-ec2-inves/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-01-2022</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/sutrinh/"  style="color:orange">Sử Trịnh  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
                <a href="https://www.linkedin.com/in/hiepnguyendt"  style="color:orange">Thanh Hiệp </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='../../vi/'>Xây dựng sổ tay phản ứng sự cố AWS bằng Jupyter notebooks và CloudTrail Lake</a> > EC2 Investigation
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#giới-thiệu">Giới thiệu</a></li>
        <li><a href="#bước-1---thiết-lập-cloudtrail-lake">Bước 1 - Thiết lập CloudTrail Lake</a></li>
        <li><a href="#bước-2---ivestigation">Bước 2 - Ivestigation</a></li>
        <li><a href="#22-điều-tra-hành-động-được-thực-hiện-bởi-instance-ec2">2.2 Điều tra Hành động được Thực hiện bởi Instance EC2</a></li>
        <li><a href="#23-điều-tra-cuộc-gọi-api-chỉ-đọc-được-thực-hiện-bởi-instance-ec2">2.3 Điều tra Cuộc gọi API chỉ Đọc được thực hiện bởi Instance EC2</a></li>
        <li><a href="#24-điều-tra-cuộc-gọi-s3-putobject-được-thực-hiện-bởi-instance-ec2">2.4 Điều tra Cuộc gọi S3 PutObject được Thực hiện bởi Instance EC2</a></li>
        <li><a href="#25-tổng-hợp-tất-cả">2.5 Tổng hợp tất cả</a></li>
        <li><a href="#bước-3---chính-sách-ngăn-chặn">Bước 3 - Chính sách ngăn chặn</a></li>
        <li><a href="#bước-4---tải-xuống-notebook">Bước 4 - Tải xuống Notebook</a></li>
        <li><a href="#bước-5---kết-luận">Bước 5 - Kết luận</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              EC2 Investigation
            </h1>
          

        



	
<div class="notices note" ><p>Nếu bạn không sử dụng Event Engine, vui lòng đảm bảo tất cả các mẫu CloudFormation đã triển khai thành công và bạn đã đợi ít nhất 15 phút để tạo nhật ký CloudTrail</p>
</div>

<h3 id="giới-thiệu">Giới thiệu</h3>
<p>Trong cuộc điều tra thứ hai, bạn đã biết đến một sự kiện an ninh tiềm ẩn trong tài khoản AWS của bạn, một số hành vi đáng ngờ đã được đội kỹ thuật nhận thức với một trường hợp Amazon EC2 instance cố gắng truy cập các tài nguyên mà nó không có quyền truy cập. Tại thời điểm này, họ không thể cung cấp thêm chi tiết nào, nên bạn cần thực hiện cuộc điều tra của riêng mình!</p>
<h3 id="bước-1---thiết-lập-cloudtrail-lake">Bước 1 - Thiết lập CloudTrail Lake</h3>
<p>Bạn sẽ bắt đầu bằng cách chạy ba khối mã đầu tiên của sổ ghi chú. Xem dưới đây để biết cách chạy những ô đó.
<img src="24.png" alt="Alt text">
<img src="25.png" alt="Alt text">
<img src="26.png" alt="Alt text"></p>
<h3 id="bước-2---ivestigation">Bước 2 - Ivestigation</h3>
<p><strong>2.1 Điều tra việc Listing Bucket Amazon S3 của Amazon EC2 Instance</strong>
<strong>2.1.1 Xây dựng Truy vấn</strong>
Như bạn đã biết, có một số instance Amazon EC2 đáng ngờ, bước đầu tiên là cố gắng xác định xem có bất kỳ instance nào thực hiện các hoạt động đáng ngờ. Đôi khi điều này sẽ là các hành động khám phá, chẳng hạn như liệt kê các bucket Amazon S3 để cố gắng đánh số tài nguyên trong môi trường của bạn. Điều này không phải là hoạt động bình thường mà bạn mong đợi các instance Amazon EC2 thực hiện.</p>
<p>Truy vấn đầu tiên này cho phép chúng ta xác định các instance đang thực hiện cuộc gọi <code>ListBuckets</code> cho Amazon S3, lưu ý rằng điều này được lọc để tìm kiếm một danh tính người dùng <code>like %:i-</code> để chỉ tìm kiếm các instance Amazon EC2.</p>
<pre tabindex="0"><code>select useridentity.principalid, eventsource, eventname, count(*) as total
from EDS_ID
where useridentity.principalid like &#39;%:i-%&#39;
and eventsource = &#39;s3.amazonaws.com&#39;
and eventname = &#39;ListBuckets&#39;
group by useridentity.principalid, eventsource, eventname
order by total desc
</code></pre><p><strong>2.1.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn thành.</strong></li>
</ol>
<p><strong>2.1.3 Phân tích Kết quả</strong>
Instance ID của Amazon EC2 gây ra hành vi đáng ngờ là gì?</p>
<h3 id="22-điều-tra-hành-động-được-thực-hiện-bởi-instance-ec2">2.2 Điều tra Hành động được Thực hiện bởi Instance EC2</h3>
<p>2.2.1 Xây dựng Truy vấn
Bây giờ bạn đã biết Instance ID, bạn có thể đào sâu một chút để tìm hiểu thêm về những gì instance này đã làm. Sử dụng một truy vấn tương tự như với thực thể IAM của AWS, <code>count</code> và <code>group</code> theo các cuộc gọi mà instance này đang thực hiện, bạn cũng muốn cập nhật <code>useridentity.principalid</code> để là ID của instance từ truy vấn trước đó.</p>
<p>Ví dụ, nếu Instance ID của bạn là <code>i-0123456789abcdefgh</code> thì dòng nên đọc <code>where useridentity.principalid like '%:i-0123456789abcdefgh'</code>
Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select eventname, count(*) as total
    from EDS_ID
    where useridentity.principalid like &#39;%:&lt;INSTANCE_ID&gt;&#39;
    group by eventname
    order by total desc
</code></pre><p><strong>2.2.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>instance_id</strong> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn thành.</strong>
<strong>2.2.3 Phân tích Kết quả</strong>
Cuộc gọi chính mà instance đáng ngờ của bạn đã thực hiện là gì?</li>
</ol>
<h3 id="23-điều-tra-cuộc-gọi-api-chỉ-đọc-được-thực-hiện-bởi-instance-ec2">2.3 Điều tra Cuộc gọi API chỉ Đọc được thực hiện bởi Instance EC2</h3>
<p><strong>2.3.1 Xây dựng Truy vấn</strong>
Bạn cũng có thể thực hiện một số khám phá hơn bằng cách sử dụng cờ chỉ đọc này cho chúng ta một cái nhìn nhanh về cuộc gọi nào đã được thực hiện mà chỉ là đọc, mà không cần bạn phải biết các cuộc gọi cụ thể và xem chúng có cố gắng thực hiện cuộc gọi đọc hay sửa đổi không.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select useridentity.principalid, eventsource, eventname, count(*) as total
    from EDS_ID
    where useridentity.principalid like &#39;%:&lt;INSTANCE_ID&gt;&#39;
    and readonly=true
    group by useridentity.principalid, eventsource, eventname
    order by total desc
</code></pre><p><strong>2.3.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>instance_id</strong> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn thành.</strong></li>
</ol>
<p><strong>2.3.3 Phân tích Kết quả</strong>
Cuộc gọi chỉ đọc nào mà instance đáng ngờ của bạn đã thực hiện?</p>
<h3 id="24-điều-tra-cuộc-gọi-s3-putobject-được-thực-hiện-bởi-instance-ec2">2.4 Điều tra Cuộc gọi S3 PutObject được Thực hiện bởi Instance EC2</h3>
<p><strong>2.4.1 Xây dựng Truy vấn</strong>
Từ một trong những truy vấn trước đây của bạn, bạn có thể đã nhận thức được rằng instance Amazon EC2 bị chiếm đóng đã thực hiện một số cuộc gọi <code>PutObject</code> đến Amazon S3. Hãy điều tra thêm xem instance đã thực hiện cuộc gọi <code>PutObject</code> nào đến Amazon S3. Bạn có thể sử dụng trường <code>requestParameters</code> để biết một số chi tiết về những gì instance đáng ngờ của bạn đã làm!</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select useridentity.principalid, eventname, eventsource, requestparameters
    from EDS_ID
    where useridentity.principalid like &#39;%:&lt;INSTANCE_ID&gt;&#39;
    and eventsource = &#39;s3.amazonaws.com&#39;
    and eventname = &#39;PutObject&#39;
</code></pre><p><strong>2.4.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>instance_id</strong> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn thành.</strong></li>
</ol>
<p><strong>2.4.3 Phân tích Kết quả</strong>
Instance bị chiếm đóng của bạn đã tải lên Amazon S3 những tệp nào?</p>
<h3 id="25-tổng-hợp-tất-cả">2.5 Tổng hợp tất cả</h3>
<p><strong>2.5.1 Xây dựng Truy vấn</strong>
Tổng hợp các truy vấn trước đó và những gì bạn đã tìm hiểu từ cuộc điều tra đầu tiên, để tạo ra một truy vấn duy nhất hiển thị tên sự kiện và dịch vụ AWS nơi các yêu cầu được thực hiện bởi instance Amazon EC2 bị chiếm đóng.</p>
<p>Xem gợi ý dưới đây!</p>
<pre tabindex="0"><code>select eventname, count(*) as total, eventsource, awsregion
    from EDS_ID
    where useridentity.principalid like &#39;%:&lt;INSTANCE_ID&gt;&#39;
    group by eventname, eventsource, awsregion
    order by total desc
</code></pre><p><strong>2.5.2 Chạy Truy vấn</strong></p>
<ol>
<li>Đảm bảo bạn dán <strong>EDS_ID</strong> và <strong>instance_id</strong> của mình vào truy vấn.</li>
<li>Chạy ô truy vấn.</li>
<li>Chạy ô kết quả. <strong>Lưu ý: bạn có thể cần khoảng 30 giây để truy vấn hoàn thành.</strong></li>
</ol>
<p><strong>2.5.3 Phân tích Kết quả</strong>
Các hành động, dịch vụ và khu vực AWS mà instance bị chiếm đóng của bạn đã gọi là gì?</p>
<h3 id="bước-3---chính-sách-ngăn-chặn">Bước 3 - Chính sách ngăn chặn</h3>
<p>Để bảo vệ instance Amazon EC2 và ngăn chặn việc sử dụng tiếp theo, bạn nên đặt nó vào một nhóm bảo mật mới, có giới hạn (thay vì thay đổi nhóm bảo mật hiện tại vì điều này sẽ không kết thúc các phiên hoạt động), và tạo snapshot cho ổ đĩa EBS để điều tra sau này.</p>
<p>Trong mã sau, thay thế <code>'INSTANCE_ID'</code> bằng ID của instance Amazon EC2 bị chiếm đóng. Mã Python sẽ tạo ra một bản snapshot của ổ đĩa EBS để điều tra sau này, sau đó tạo ra một nhóm bảo mật mới không có quy tắc truy nhập hoặc truy xuất và gắn nó vào instance. Tiếp theo, nó sẽ loại bỏ nhóm bảo mật cũ để kết thúc bất kỳ phiên hoạt động nào đang hoạt động. Cuối cùng, nó sẽ chấm dứt instance.</p>
<p>Ngay trước khi chấm dứt, có một điều kiện chờ để cho phép chụp ảnh nhanh trước khi chấm dứt phiên bản, vì vậy mã này sẽ mất 40-50 giây để chạy.</p>
<p><strong>3.1 Snapshot</strong>
import time
instance_id=&lsquo;ENTER INSTANCE ID&rsquo;
ec2=boto3.resource(&rsquo;ec2&rsquo;)
instance=ec2.Instance(instance_id)
ebs_vol=instance.block_device_mappings[0][&lsquo;Ebs&rsquo;][&lsquo;VolumeId&rsquo;]
response=ec2.create_snapshot(VolumeId=ebs_vol)
print(response)</p>
<p><strong>3.2 Chính sách ngăn chặn</strong></p>
<pre tabindex="0"><code>time.sleep(30) # allow snapshot to finish
vpc_id=instance.vpc_id
security_group=instance.security_groups[0][&#39;GroupId&#39;]
ec2_client=boto3.client(&#39;ec2&#39;)
response=ec2_client.create_security_group(
    GroupName=&#39;Restricted_Group&#39;,
    Description=&#39;Restricts_access&#39;,
    VpcId=vpc_id
)
restricted_sg=ec2.SecurityGroup(response[&#39;GroupId&#39;])
response=restricted_sg.revoke_egress(
    IpPermissions=restricted_sg.ip_permissions_egress
)
response=instance.modify_attribute(Groups=[restricted_sg.id])
instance.terminate()
</code></pre><h3 id="bước-4---tải-xuống-notebook">Bước 4 - Tải xuống Notebook</h3>
<p>Chọn <strong>File</strong>, sau đó chọn <strong>Download as</strong>, tiếp đó chọn <strong>Notebook (.ipynb)</strong>. Điều này phục vụ để làm bằng chứng cho cuộc điều tra của bạn.
<img src="27.png" alt="Alt text"></p>
<h3 id="bước-5---kết-luận">Bước 5 - Kết luận</h3>
<p>Bạn đã thành công trong việc:</p>
<ol>
<li>Thực hiện các hoạt động khám phá và điều tra cho hoạt động đáng ngờ được báo cáo.</li>
<li>Xác định Amazon EC2 instance bị tấn công và tìm hiểu các hành động nó đã thực hiện.</li>
<li>Cô lập instance trong một nhóm bảo mật bị hạn chế để ngăn chặn truy cập, tạo một bản snapshot của ổ đĩa Amazon EBS để điều tra trong tương lai, và sau đó chấm dứt instance.</li>
</ol>
<p><strong>Những bước nào có thể được thực hiện để ngăn chặn Amazon EC2 instance khỏi việc truy cập không mong muốn?</strong></p>
<p>Xem câu trả lời ở đây!
Sử dụng lệnh chạy AWS Systems Manager hoặc trình quản lý phiên thay vì khóa SSH</p>
<p>Hạn chế các nhóm bảo mật và NACL ở tất cả các lớp</p>
<p>Đảm bảo các phiên bản patched và cập nhật hoặc sử dụng cơ sở hạ tầng bất biến</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../vi/4-iam-ives/" title="IAM Investigation"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../vi/6-incident-runbook/" title="Sổ tay quản lý rủi ro" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1705746998"></script>
    <script src="../../js/perfect-scrollbar.min.js?1705746998"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1705746998"></script>
    <script src="../../js/jquery.sticky.js?1705746998"></script>
    <script src="../../js/featherlight.min.js?1705746998"></script>
    <script src="../../js/highlight.pack.js?1705746998"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js?1705746998"></script>
    <script src="../../js/learn.js?1705746998"></script>
    <script src="../../js/hugo-learn.js?1705746998"></script>

    <link href="../../mermaid/mermaid.css?1705746998" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js?1705746998"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
